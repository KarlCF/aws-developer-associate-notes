## **AWS Fundamentals Part 2: ELB + ASG + EBS**

## Load balancers

* Application Load Balancer (v2)
  * Works on Layer 7 (HTTP)
  * Load balancing multiple HTTP application accros machines (target groups)
  * Load balancing to multiple applications on the same machine (ex: containers)
  * Support for HTTP/2 and WebSocket
  * Support redirects (from HTTP to HTTPS for example)
  * Load balancing based on route in URL
  * Load balancing based on hostname URL
  * Has a port mapping feature to redirect to a dynamic port
  * Great for micro services & container-based application (ex: Docker & Amazon ECS)
  * Routing tables to different target groups:
    * Routing based on path in URL (example.com/users & example.com/posts)
    * Routing based on hostname in URL (one.example.com & other.example.com)
  * 

  * ### **Good to know:**

  * Stickiness can be enabled at the target group level
    * Same requests to the same instance
    * Stickiness is directly generated by the ALB (not the application)
  * ALB supports HTTP/HTTPS & Websockets protocols
  * The application servers don't see the IP of the client directly
    * The true IP of the client is inserted in the header X-Forwarded-For
    * We can also get Port (X-Forwarded-Port) and proto (X-Forwarded-Proto)

* Network Load Balancer (v2)
  * Forward TCP & UDP (Layer 4) traffict to your instances
  * Handle millions of requests per seconds
  * NLB has **one static IP per AZ**, and supports assigning Elastic IP (helpful for whitelisting specific IPs)
  * Support for static IP or elastic IP
  * Less latency: ~ 100 ms (vs 400 ms for ALB)
  * Mostly used for extreme performance, should not be the default load balancer you chose

### Load Balancer Stickiness

* It is possible to implement stickiness so that same client is always redirected to the same instance behind a load balance (Works for CLB & ALB)
* The "cookie" used for stickiness has an expiration date you control
* Use case: make sure the user doesn't lose his session data
* Enabling stickiness may bring imbalance to the load over the backend EC2 instances

### Cross-Zone Load Balancing

* With Cross Zone Load Balancing each load balancer instance distributes evenly across all registered instances in all AZ
* Otherwise, each load balancer node distributes requests evently across the registered instances in its Availability Zone only
* Classic Load Balancer
  * Disabled by default
  * No charges for inter AZ data if enabled
* Application Load Balancer
  * Always on (can't be disabled)
  * No charges for inter AZ data
* Network Load Balancer
  * Disabled by default
  * Charges are generated for inter AZ data if enabled

### SSL/TLS - Basics

* An SSL Certificate allows traffic between your clients and your load balancer to be encrypted in transit (in-flight encryption)
* SSL refers to Secure Sockets Layer, used to encrypt connections
* TLS refers to Transport Layer Security, which is the newer version
* TLS certificates are mainly used, but it is still referred as SSL
* Public SSL certificates are issued by Certificate Autorities (CA)
  * Comodo, Symantec, GoDaddy, GlobalSign, Letsencrypt, etc...
* SSL certificates have an expiration date (you set) and must be renewed
* The load balancer uses an X.509 certificate (SSL/TLS server certificate)
* You can manage certificates using ACM (AWS certificate Manager)
* You can upload your own certificates alternatively
* HTTPS listener:
  * You can specify a default certificate
  * You can add an optional list of certs to support multiple domains
  * Clients can use SNI (Server Name Indication) to specify the hostname they reach
  * Ability to specify a security policy to support older versions of SSL/TLS (legacy clients)
* SSL - SNI(Server Name Indication)
  * SNI solves the problem of loading multiple SSL certificates onto one web server (to serve multiple websites)
  * It's a "newer" protocol, and requires the client to indicate the hostname of the target server in the initial SSL handshake
  * The server will then find the correct certificate, or return the default one
  * Only works for NLB & ALB and CloudFront

### ELB - Connection Draining

* Feature naming:
  * CLB: Connection Draining
  * Target Group: Deregistration Delay (ALB & NLB)
* Time to complete "in-flight requests" while the instance is de-registering or unhealthy
* Stops sending new requests to the instance which is de-registering
* Can be set between 1 to 3600 seconds, default is 300.
* Can be disabled (set value to 0)
* Set a low value if your requests are short


### **Good to know:**

* Classic Load Balancers are Depreacted
  * ALB for HTTP / HTTPs & Websocket
  * Network Load Balancer for TCP
* CLB and ALB support SSL certificates and provide SSL termination
* All Load Balancers have health check capability
* ALB can route based on hostname / path
* ALB is a great fit with ECS (Docker)
* Any Load Balancer (CLB, ALB, NLB) has a static host name. Do not resolve and use underlying IP
* LBs can scale but not instantaneously - contact AWS beforehand for a "warm-up"
* NLB directly see the client IP
* 4xx errors are client induced errors
* 5xx errors are application induced errors
  * Load Balancer Errors 503 means at capacity or no registered target
* If the LB can't connect to your application, check your security groups!
* Monitoring
  * ELB access logs will log all access requests (so you can debug per request)
  * CloudWatch Metrics will give you aggregate statistics (ex: connections count)

## Auto Scaling Group

* Handles scaling (in and out) to a minimum and maximum configured
* Automatically register new instances to a load balancer
* It is possible to scale an ASG based on CloudWatch alarms

### ASGs have the following attributes

* A launch configuration
  * AMI + Instance type
  * EC2 User data
  * EBS Volumes
  * Security Groups
  * SSH Key Pair
* Min Size / Max Size / Initial Capacity
* Network + Subnets Information
* Load Balancer Information (Or target group info)
* Scaling Policies
### Auto Scaling Groups - Scaling Policies

* **Target Tracking Scaling**
  * Most simple and easy to set-up
  * EX: Configure the ASG CPU to stay at around 40%
* **Simple / Step Scaling**
  * When a CloudWatch alarm is triggered scale-in or scale-out
* **Scheduled Actions**
  * Anticipate a scaling based on known usage patterns

### Auto Scaling new Rules

* It is now possible to define more refined auto scale rules that are directly managed by EC2
  * Target Average CPU Usage
  * Number of requests on the ELB per instance
  * Average Network In
  * Average Network Out
* These rules are easier to set up and can make more sense

### **Good to Know:**

* Scaling policies can be any CloudWatch metrics (Native or custom) and even based on schedule
* ASGs use Launch configurations and you update an ASG by providing a new launch configuration
* IAM roles attached to an ASG will get assigned to EC2 instances
* Instances marked as Unhealthy are terminated by the ASG and replaced
